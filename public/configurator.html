<!DOCTYPE html>
<html lang="lt" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talp≈≥ konfig≈´ratorius</title>
    <link href="output.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        #canvas-container {
            min-height: 400px;
            position: relative;
        }
        
        #canvas-container canvas {
            border-radius: 8px;
            display: block !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .step-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .step-active {
            background-color: #0ea5e4;
            color: white;
        }
        
        .step-completed {
            background-color: #22c55e;
            color: white;
        }
        
        .step-inactive {
            background-color: #f3f4f6;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-base-200 text-base-content min-h-screen">
    <!-- Header -->
    <div class="navbar bg-base-100 shadow-sm border-b border-base-300">
        <div class="navbar-start">
            <a href="dashboard.html" class="btn btn-ghost btn-sm">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Atgal
            </a>
            <div class="text-xl font-bold text-primary ml-4">
                üè≠ Talp≈≥ konfig≈´ratorius
            </div>
        </div>
        
        <div class="navbar-center">
            <span id="projectTitle" class="text-lg font-medium">Naujas projektas</span>
        </div>
        
        <div class="navbar-end">
            <div class="flex items-center gap-2">
                <button class="btn btn-ghost btn-sm" onclick="saveProject()">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    I≈°saugoti
                </button>
                <button class="btn btn-ghost btn-sm" onclick="exportProject()">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Eksportuoti
                </button>
                <span class="text-sm">Sveiki, <span id="username">Vartotojas</span></span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex h-screen overflow-hidden">
        <!-- Left Sidebar - Configuration Steps (60%) -->
        <div class="w-3/5 bg-base-100 border-r border-base-300 overflow-y-auto">
            <!-- Steps Navigation -->
            <div class="p-6 border-b border-base-300 bg-base-50">
                <h2 class="text-lg font-semibold mb-4">Konfig≈´ravimo ≈æingsniai</h2>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="step-indicator step-active" id="step1-indicator">1</div>
                        <span class="ml-2 text-sm font-medium">Matmenys</span>
                    </div>
                    <div class="h-px bg-base-300 flex-1"></div>
                    <div class="flex items-center">
                        <div class="step-indicator step-inactive" id="step2-indicator">2</div>
                        <span class="ml-2 text-sm text-base-content/60">Med≈æiagos</span>
                    </div>
                    <div class="h-px bg-base-300 flex-1"></div>
                    <div class="flex items-center">
                        <div class="step-indicator step-inactive" id="step3-indicator">3</div>
                        <span class="ml-2 text-sm text-base-content/60">Komponentai</span>
                    </div>
                    <div class="h-px bg-base-300 flex-1"></div>
                    <div class="flex items-center">
                        <div class="step-indicator step-inactive" id="step4-indicator">4</div>
                        <span class="ml-2 text-sm text-base-content/60">Ataskaita</span>
                    </div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="p-6">
                <!-- Step 1: Dimensions -->
                <div id="step1-content" class="step-content">
                    <h3 class="text-xl font-semibold mb-6">Talpos matmenys</h3>
                    
                    <!-- Tank Type Selection -->
                    <div class="mb-8">
                        <label class="label">
                            <span class="label-text font-medium">Talpos tipas</span>
                        </label>
                        <div class="grid grid-cols-3 gap-4">
                            <label class="cursor-pointer">
                                <input type="radio" name="tankType" value="vertical" class="hidden" checked onchange="updateTankType()">
                                <div class="card bg-base-100 border-2 border-base-300 hover:border-primary transition-colors p-4 text-center tank-type-card active">
                                    <div class="text-3xl mb-2">‚¨ÜÔ∏è</div>
                                    <div class="text-sm font-medium">Vertikalus</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="tankType" value="horizontal" class="hidden" onchange="updateTankType()">
                                <div class="card bg-base-100 border-2 border-base-300 hover:border-primary transition-colors p-4 text-center tank-type-card">
                                    <div class="text-3xl mb-2">‚ÜîÔ∏è</div>
                                    <div class="text-sm font-medium">Horizontalus</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="tankType" value="spherical" class="hidden" onchange="updateTankType()">
                                <div class="card bg-base-100 border-2 border-base-300 hover:border-primary transition-colors p-4 text-center tank-type-card">
                                    <div class="text-3xl mb-2">üî¥</div>
                                    <div class="text-sm font-medium">Sferinis</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Dimensions Form -->
                    <div class="space-y-6">
                        <div id="verticalDimensions" class="dimensions-form">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Auk≈°tis (m)</span>
                                    </label>
                                    <input type="number" id="height" placeholder="10" step="0.1" min="0.1" 
                                           class="input input-bordered" onchange="updateDimensions()">
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Skersmuo (m)</span>
                                    </label>
                                    <input type="number" id="diameter" placeholder="5" step="0.1" min="0.1" 
                                           class="input input-bordered" onchange="updateDimensions()">
                                </div>
                            </div>
                        </div>

                        <div id="horizontalDimensions" class="dimensions-form hidden">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Ilgis (m)</span>
                                    </label>
                                    <input type="number" id="length" placeholder="10" step="0.1" min="0.1" 
                                           class="input input-bordered" onchange="updateDimensions()">
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Plotis (m)</span>
                                    </label>
                                    <input type="number" id="width" placeholder="3" step="0.1" min="0.1" 
                                           class="input input-bordered" onchange="updateDimensions()">
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Auk≈°tis (m)</span>
                                    </label>
                                    <input type="number" id="height2" placeholder="2" step="0.1" min="0.1" 
                                           class="input input-bordered" onchange="updateDimensions()">
                                </div>
                            </div>
                        </div>

                        <div id="sphericalDimensions" class="dimensions-form hidden">
                            <div class="form-control max-w-sm">
                                <label class="label">
                                    <span class="label-text">Skersmuo (m)</span>
                                </label>
                                <input type="number" id="sphereDiameter" placeholder="8" step="0.1" min="0.1" 
                                       class="input input-bordered" onchange="updateDimensions()">
                            </div>
                        </div>

                        <!-- Wall Thickness -->
                        <div class="form-control max-w-sm">
                            <label class="label">
                                <span class="label-text">Sieneli≈≥ storis (mm)</span>
                            </label>
                            <input type="number" id="wallThickness" placeholder="6" step="0.1" min="1" 
                                   class="input input-bordered" onchange="updateDimensions()">
                        </div>

                        <!-- Calculated Volume -->
                        <div class="bg-base-200 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium">Apskaiƒçiuotas t≈´ris:</span>
                                <span id="calculatedVolume" class="text-lg font-bold text-primary">0 m¬≥</span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between mt-8 pt-6 border-t border-base-300">
                        <button class="btn btn-ghost" onclick="goToDashboard()">
                            At≈°aukti
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()">
                            Toliau
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Placeholder for other steps -->
                <div id="step2-content" class="step-content hidden">
                    <h3 class="text-xl font-semibold mb-6">Med≈æiagos ir dangos</h3>
                    <p class="text-base-content/70">Med≈æiag≈≥ pasirinkimas - netrukus!</p>
                </div>

                <div id="step3-content" class="step-content hidden">
                    <h3 class="text-xl font-semibold mb-6">Komponentai ir priedai</h3>
                    <p class="text-base-content/70">Komponent≈≥ konfig≈´racija - netrukus!</p>
                </div>

                <div id="step4-content" class="step-content hidden">
                    <h3 class="text-xl font-semibold mb-6">Ataskaita ir eksportas</h3>
                    <p class="text-base-content/70">Galutinƒó ataskaita - netrukus!</p>
                </div>
            </div>
        </div>

        <!-- Right Side - 3D Viewer (40%) -->
        <div class="w-2/5 bg-base-100 flex flex-col">
            <!-- 3D Viewer Header -->
            <div class="p-4 border-b border-base-300 bg-base-50">
                <h3 class="text-lg font-semibold">3D per≈æi≈´ra</h3>
                <div class="flex gap-2 mt-2">
                    <button class="btn btn-xs btn-outline" onclick="resetCamera()">Atkurti vaizdƒÖ</button>
                    <button class="btn btn-xs btn-outline" onclick="toggleWireframe()">Tinklelis</button>
                </div>
            </div>

            <!-- 3D Canvas Container -->
            <div class="flex-1 p-4">
                <div id="canvas-container" class="w-full h-full bg-base-200 rounded-lg flex items-center justify-center">
                    <div id="loading" class="text-center">
                        <div class="loading loading-spinner loading-lg text-primary mb-4"></div>
                        <p class="text-base-content/70">Kraunama 3D per≈æi≈´ra...</p>
                    </div>
                </div>
            </div>

            <!-- 3D Controls Info -->
            <div class="p-4 border-t border-base-300 bg-base-50">
                <div class="text-xs text-base-content/60 space-y-1">
                    <div>üñ±Ô∏è Pelƒós ratas: artinti/tolinti</div>
                    <div>üîÑ Vilkti pele: sukti vaizdƒÖ</div>
                    <div>‚å®Ô∏è Shift + vilkti: slinkti</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from './three.module.js';
        
        // Make THREE globally available for the rest of the scripts
        window.THREE = THREE;
        
        console.log('‚úÖ THREE.js ES module loaded successfully!');
        
        // Dispatch custom event to notify that THREE is ready
        window.dispatchEvent(new CustomEvent('threeLoaded'));
    </script>
    <script src="api.js"></script>
    <script>
        let currentStep = 1;
        let currentProject = null;
        let tankConfig = {
            type: 'vertical',
            height: 10,
            diameter: 5,
            length: 10,
            width: 3,
            height2: 2,
            sphereDiameter: 8,
            wallThickness: 6
        };

        // 3D Tank Configurator Class
        class TankConfigurator3D {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.tank = null;
                this.lights = [];
                this.isWireframe = false;
                
                this.init();
                this.createLights();
                this.createTank();
                this.animate();
            }

            init() {
                const container = document.getElementById('canvas-container');
                if (!container) return;

                // Get container dimensions
                const rect = container.getBoundingClientRect();
                
                // Renderer setup
                this.renderer.setSize(rect.width, rect.height);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.setClearColor(0xf9fafb, 1);
                
                // Clear loading and add canvas
                container.innerHTML = '';
                container.appendChild(this.renderer.domElement);
                
                // Camera position
                this.camera.aspect = rect.width / rect.height;
                this.camera.updateProjectionMatrix();
                this.camera.position.set(15, 10, 15);
                this.camera.lookAt(0, 0, 0);
                
                // Scene background
                this.scene.background = new THREE.Color(0xf9fafb);
                
                // Add ground
                this.createGround();
                
                // Setup mouse controls
                this.setupMouseControls();
                
                // Handle window resize
                window.addEventListener('resize', () => this.onWindowResize());
            }

            createLights() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                this.lights.push(ambientLight);
                
                // Directional light (sun)
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(20, 20, 10);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                directionalLight.shadow.camera.near = 0.1;
                directionalLight.shadow.camera.far = 100;
                directionalLight.shadow.camera.left = -20;
                directionalLight.shadow.camera.right = 20;
                directionalLight.shadow.camera.top = 20;
                directionalLight.shadow.camera.bottom = -20;
                this.scene.add(directionalLight);
                this.lights.push(directionalLight);
                
                // Point light for extra illumination
                const pointLight = new THREE.PointLight(0xffffff, 0.4);
                pointLight.position.set(-15, 15, -15);
                this.scene.add(pointLight);
                this.lights.push(pointLight);
            }

            createGround() {
                const groundGeometry = new THREE.PlaneGeometry(50, 50);
                const groundMaterial = new THREE.MeshLambertMaterial({
                    color: 0xe5e7eb,
                    transparent: true,
                    opacity: 0.8
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                this.scene.add(ground);
            }

            createTank() {
                if (this.tank) {
                    this.scene.remove(this.tank);
                }
                
                this.tank = new THREE.Group();
                
                const material = new THREE.MeshPhongMaterial({
                    color: 0x0ea5e4,
                    shininess: 30,
                    wireframe: this.isWireframe
                });
                
                let tankMesh;
                
                switch (tankConfig.type) {
                    case 'vertical':
                        tankMesh = this.createVerticalTank(material);
                        break;
                    case 'horizontal':
                        tankMesh = this.createHorizontalTank(material);
                        break;
                    case 'spherical':
                        tankMesh = this.createSphericalTank(material);
                        break;
                    default:
                        tankMesh = this.createVerticalTank(material);
                }
                
                tankMesh.castShadow = true;
                tankMesh.receiveShadow = true;
                this.tank.add(tankMesh);
                
                // Add to scene
                this.scene.add(this.tank);
            }

            createVerticalTank(material) {
                const radius = tankConfig.diameter / 2;
                const height = tankConfig.height;
                const geometry = new THREE.CylinderGeometry(radius, radius, height, 32);
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = height / 2;
                return mesh;
            }

            createHorizontalTank(material) {
                const geometry = new THREE.BoxGeometry(
                    tankConfig.length, 
                    tankConfig.height2, 
                    tankConfig.width
                );
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = tankConfig.height2 / 2;
                return mesh;
            }

            createSphericalTank(material) {
                const radius = tankConfig.sphereDiameter / 2;
                const geometry = new THREE.SphereGeometry(radius, 32, 16);
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.y = radius;
                return mesh;
            }

            setupMouseControls() {
                let isMouseDown = false;
                let mouseX = 0;
                let mouseY = 0;
                let isShiftPressed = false;
                const rotationSpeed = 0.005;
                const panSpeed = 0.1;
                
                // Track shift key
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'Shift') isShiftPressed = true;
                });
                
                window.addEventListener('keyup', (e) => {
                    if (e.key === 'Shift') isShiftPressed = false;
                });
                
                this.renderer.domElement.addEventListener('mousedown', (e) => {
                    isMouseDown = true;
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                
                window.addEventListener('mouseup', () => {
                    isMouseDown = false;
                });
                
                this.renderer.domElement.addEventListener('mousemove', (e) => {
                    if (!isMouseDown) return;
                    
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    if (isShiftPressed) {
                        // Pan camera
                        const vector = new THREE.Vector3();
                        vector.setFromMatrixColumn(this.camera.matrix, 0);
                        vector.multiplyScalar(-deltaX * panSpeed * 0.01);
                        this.camera.position.add(vector);
                        
                        vector.setFromMatrixColumn(this.camera.matrix, 1);
                        vector.multiplyScalar(deltaY * panSpeed * 0.01);
                        this.camera.position.add(vector);
                    } else {
                        // Rotate camera around origin
                        const spherical = new THREE.Spherical();
                        spherical.setFromVector3(this.camera.position);
                        spherical.theta -= deltaX * rotationSpeed;
                        spherical.phi += deltaY * rotationSpeed;
                        spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                        
                        this.camera.position.setFromSpherical(spherical);
                        this.camera.lookAt(0, 0, 0);
                    }
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
                
                // Mouse wheel for zoom
                this.renderer.domElement.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const zoomSpeed = 0.1;
                    const direction = this.camera.position.clone().normalize();
                    
                    if (e.deltaY > 0 && this.camera.position.length() < 100) {
                        this.camera.position.add(direction.multiplyScalar(zoomSpeed));
                    } else if (e.deltaY < 0 && this.camera.position.length() > 2) {
                        this.camera.position.sub(direction.multiplyScalar(zoomSpeed));
                    }
                });
            }

            updateTank(config) {
                // Update global config
                Object.assign(tankConfig, config);
                this.createTank();
            }

            resetCamera() {
                this.camera.position.set(15, 10, 15);
                this.camera.lookAt(0, 0, 0);
            }

            toggleWireframe() {
                this.isWireframe = !this.isWireframe;
                this.createTank();
            }

            onWindowResize() {
                const container = document.getElementById('canvas-container');
                if (!container) return;
                
                const rect = container.getBoundingClientRect();
                this.camera.aspect = rect.width / rect.height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(rect.width, rect.height);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.renderer.render(this.scene, this.camera);
            }
        }

        // Initialize 3D configurator when THREE is loaded
        let configurator3D = null;
        
        window.addEventListener('threeLoaded', () => {
            console.log('üöÄ THREE.js loaded, initializing 3D configurator...');
            
            try {
                configurator3D = new TankConfigurator3D();
                console.log('‚úÖ 3D Configurator created successfully');
                
                // Make functions available globally
                window.updateTank3D = (config) => {
                    if (configurator3D) {
                        configurator3D.updateTank(config);
                    }
                };
                
                window.resetCamera3D = () => {
                    if (configurator3D) {
                        configurator3D.resetCamera();
                    }
                };
                
                window.toggleWireframe3D = () => {
                    if (configurator3D) {
                        configurator3D.toggleWireframe();
                    }
                };
                
                // Initial tank creation
                setTimeout(() => {
                    if (configurator3D) {
                        configurator3D.updateTank(tankConfig);
                    }
                }, 100);
            } catch (error) {
                console.error('‚ùå Error initializing 3D configurator:', error);
            }
        });

        // Initialize page
        window.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadProject();
            updateDimensions();
        });

        async function checkAuth() {
            if (!authAPI.isAuthenticated()) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await authAPI.getCurrentUser();
                document.getElementById('username').textContent = response.user.name || 'Vartotojas';
            } catch (error) {
                console.error('Auth check failed:', error);
                await authAPI.logout();
                window.location.href = 'index.html';
            }
        }

        function loadProject() {
            const project = localStorage.getItem('currentProject');
            if (project) {
                try {
                    console.log('üîç Loading project from localStorage:', project);
                    currentProject = JSON.parse(project);
                    
                    // Validate project structure
                    if (!currentProject || typeof currentProject !== 'object') {
                        throw new Error('Invalid project structure');
                    }
                    
                    console.log('‚úÖ Project loaded successfully:', currentProject);
                    
                    document.getElementById('projectTitle').textContent = currentProject.name || 'Naujas projektas';
                    
                    // Load configuration if available and valid
                    if (currentProject.configuration && 
                        typeof currentProject.configuration === 'object' && 
                        Object.keys(currentProject.configuration).length > 0) {
                        
                        console.log('üîß Loading project configuration:', currentProject.configuration);
                        tankConfig = { ...tankConfig, ...currentProject.configuration };
                        
                        // Update form fields
                        updateFormFields();
                    }
                    
                    // Set tank type if available
                    if (currentProject.type) {
                        console.log('üèóÔ∏è Setting tank type:', currentProject.type);
                        tankConfig.type = currentProject.type;
                        
                        // Check if radio button exists before setting
                        const radioButton = document.querySelector(`input[value="${currentProject.type}"]`);
                        if (radioButton) {
                            radioButton.checked = true;
                            updateTankType();
                        } else {
                            console.warn('‚ö†Ô∏è Tank type radio button not found for:', currentProject.type);
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Invalid project data:', e);
                    console.log('üßπ Clearing invalid project data from localStorage');
                    
                    // Clear invalid data from localStorage
                    localStorage.removeItem('currentProject');
                    currentProject = null;
                    
                    // Show user-friendly message
                    showToast('Nepavyko u≈ækrauti projekto duomen≈≥. Pradƒósime naujƒÖ projektƒÖ.', 'warning');
                    
                    // Reset to default state
                    document.getElementById('projectTitle').textContent = 'Naujas projektas';
                }
            } else {
                console.log('‚ÑπÔ∏è No project data in localStorage');
            }
        }

        function updateFormFields() {
            // Update dimension inputs based on tank type
            const type = tankConfig.type;
            
            if (type === 'vertical') {
                document.getElementById('height').value = tankConfig.height;
                document.getElementById('diameter').value = tankConfig.diameter;
            } else if (type === 'horizontal') {
                document.getElementById('length').value = tankConfig.length;
                document.getElementById('width').value = tankConfig.width;
                document.getElementById('height2').value = tankConfig.height2;
            } else if (type === 'spherical') {
                document.getElementById('sphereDiameter').value = tankConfig.sphereDiameter;
            }
            
            document.getElementById('wallThickness').value = tankConfig.wallThickness;
        }

        function updateTankType(event) {
            const type = document.querySelector('input[name="tankType"]:checked').value;
            tankConfig.type = type;
            
            // Update visual selection - only if event is provided (user interaction)
            if (event && event.target) {
                document.querySelectorAll('.tank-type-card').forEach(card => card.classList.remove('active'));
                event.target.closest('label').querySelector('.tank-type-card').classList.add('active');
            } else {
                // Fallback for programmatic calls - find the checked input and update its visual
                const checkedInput = document.querySelector('input[name="tankType"]:checked');
                if (checkedInput) {
                    document.querySelectorAll('.tank-type-card').forEach(card => card.classList.remove('active'));
                    checkedInput.closest('label').querySelector('.tank-type-card').classList.add('active');
                }
            }
            
            // Show/hide appropriate dimension forms
            document.querySelectorAll('.dimensions-form').forEach(form => form.classList.add('hidden'));
            document.getElementById(`${type}Dimensions`).classList.remove('hidden');
            
            updateDimensions();
        }

        function updateDimensions() {
            // Get current values
            const type = tankConfig.type;
            
            if (type === 'vertical') {
                tankConfig.height = parseFloat(document.getElementById('height').value) || 10;
                tankConfig.diameter = parseFloat(document.getElementById('diameter').value) || 5;
            } else if (type === 'horizontal') {
                tankConfig.length = parseFloat(document.getElementById('length').value) || 10;
                tankConfig.width = parseFloat(document.getElementById('width').value) || 3;
                tankConfig.height2 = parseFloat(document.getElementById('height2').value) || 2;
            } else if (type === 'spherical') {
                tankConfig.sphereDiameter = parseFloat(document.getElementById('sphereDiameter').value) || 8;
            }
            
            tankConfig.wallThickness = parseFloat(document.getElementById('wallThickness').value) || 6;
            
            // Calculate volume
            let volume = 0;
            if (type === 'vertical') {
                const radius = tankConfig.diameter / 2;
                volume = Math.PI * radius * radius * tankConfig.height;
            } else if (type === 'horizontal') {
                volume = tankConfig.length * tankConfig.width * tankConfig.height2;
            } else if (type === 'spherical') {
                const radius = tankConfig.sphereDiameter / 2;
                volume = (4/3) * Math.PI * radius * radius * radius;
            }
            
            document.getElementById('calculatedVolume').textContent = volume.toFixed(2) + ' m¬≥';
            
            // Update 3D view (will be implemented with Three.js)
            if (window.updateTank3D) {
                window.updateTank3D(tankConfig);
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(content => content.classList.add('hidden'));
            
            // Show current step content
            document.getElementById(`step${step}-content`).classList.remove('hidden');
            
            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                if (i < step) {
                    indicator.className = 'step-indicator step-completed';
                } else if (i === step) {
                    indicator.className = 'step-indicator step-active';
                } else {
                    indicator.className = 'step-indicator step-inactive';
                }
            }
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        async function saveProject() {
            if (!currentProject) {
                showToast('Klaida: projektas nerastas', 'error');
                return;
            }

            try {
                const response = await projectsAPI.updateProject(currentProject.id, {
                    name: currentProject.name,
                    type: tankConfig.type,
                    volume: parseFloat(document.getElementById('calculatedVolume').textContent) || 0,
                    configuration: tankConfig
                });
                
                showToast(response.message || 'Projektas i≈°saugotas!', 'success');
                
                // Update current project with new data
                currentProject = response.project;
                localStorage.setItem('currentProject', JSON.stringify(currentProject));
            } catch (error) {
                console.error('Save project error:', error);
                showToast(error.message || 'Nepavyko i≈°saugoti projekto', 'error');
            }
        }

        function exportProject() {
            showToast('Eksportavimas - netrukus!', 'info');
        }

        function resetCamera() {
            if (window.resetCamera3D) {
                window.resetCamera3D();
            }
        }

        function toggleWireframe() {
            if (window.toggleWireframe3D) {
                window.toggleWireframe3D();
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-top toast-end`;
            toast.innerHTML = `
                <div class="alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}">
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Auto-save functionality
        let saveTimeout;
        function autoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (currentProject) {
                    try {
                        await saveProject();
                        console.log('Auto-saved project');
                    } catch (error) {
                        console.error('Auto-save failed:', error);
                    }
                }
            }, 2000); // Auto-save after 2 seconds of inactivity
        }

        // Add auto-save to dimension changes
        const originalUpdateDimensions = updateDimensions;
        updateDimensions = function() {
            originalUpdateDimensions();
            autoSave();
        };

        // Make functions available globally for Three.js integration
        window.tankConfig = tankConfig;
        window.updateDimensions = updateDimensions;
    </script>
</body>
</html>